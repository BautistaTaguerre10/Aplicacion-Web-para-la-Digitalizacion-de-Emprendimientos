-- 1) Habilitar RLS en la tabla
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
-- Opcional:
-- ALTER TABLE public.profiles FORCE ROW LEVEL SECURITY;

-- 2) Políticas según tu JSON

-- SELECT: perfiles públicos visibles para todos
DROP POLICY IF EXISTS "Public profiles are viewable by everyone" ON public.profiles;
CREATE POLICY "Public profiles are viewable by everyone"
ON public.profiles
AS PERMISSIVE
FOR SELECT
TO public
USING (true);

-- UPDATE: los usuarios pueden actualizar su propio perfil
DROP POLICY IF EXISTS "Users can update their own profile" ON public.profiles;
CREATE POLICY "Users can update their own profile"
ON public.profiles
AS PERMISSIVE
FOR UPDATE
TO public
USING (auth.uid() = id);

-- SELECT: los usuarios pueden ver su propio perfil
DROP POLICY IF EXISTS "Users can view their own profile" ON public.profiles;
CREATE POLICY "Users can view their own profile"
ON public.profiles
AS PERMISSIVE
FOR SELECT
TO public
USING (auth.uid() = id);

-- DELETE: solo dueño del perfil
DROP POLICY IF EXISTS profiles_delete_owner_only ON public.profiles;
CREATE POLICY profiles_delete_owner_only
ON public.profiles
AS PERMISSIVE
FOR DELETE
TO public
USING (id = auth.uid());

-- INSERT: solo si id = auth.uid()
DROP POLICY IF EXISTS profiles_insert_owner_only ON public.profiles;
CREATE POLICY profiles_insert_owner_only
ON public.profiles
AS PERMISSIVE
FOR INSERT
TO public
WITH CHECK (id = auth.uid());

-- SELECT: solo dueño del perfil
DROP POLICY IF EXISTS profiles_select_owner_only ON public.profiles;
CREATE POLICY profiles_select_owner_only
ON public.profiles
AS PERMISSIVE
FOR SELECT
TO public
USING (id = auth.uid());

-- UPDATE: solo dueño del perfil
DROP POLICY IF EXISTS profiles_update_owner_only ON public.profiles;
CREATE POLICY profiles_update_owner_only
ON public.profiles
AS PERMISSIVE
FOR UPDATE
TO public
USING (id = auth.uid())
WITH CHECK (id = auth.uid());

-- 3) (Opcional) Índice para mejorar el rendimiento
CREATE INDEX IF NOT EXISTS idx_profiles_id ON public.profiles(id);
