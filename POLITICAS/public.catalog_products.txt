-- 1) Habilitar RLS en la tabla
ALTER TABLE public.catalog_products ENABLE ROW LEVEL SECURITY;
-- Opcional:
-- ALTER TABLE public.catalog_products FORCE ROW LEVEL SECURITY;

-- 2) Políticas

-- DELETE: permitido si sos dueño del catálogo O del producto
DROP POLICY IF EXISTS catprod_delete_owner_catalog_or_product ON public.catalog_products;
CREATE POLICY catprod_delete_owner_catalog_or_product
ON public.catalog_products
AS PERMISSIVE
FOR DELETE
TO public
USING (
  EXISTS (
    SELECT 1
    FROM public.catalogs c
    WHERE c.id = catalog_products.catalog_id
      AND c.user_id = auth.uid()
  )
  OR EXISTS (
    SELECT 1
    FROM public.products p
    WHERE p.id = catalog_products.product_id
      AND p.user_id = auth.uid()
  )
);

-- INSERT: permitido solo si sos dueño del catálogo Y del producto
DROP POLICY IF EXISTS catprod_insert_owner_both ON public.catalog_products;
CREATE POLICY catprod_insert_owner_both
ON public.catalog_products
AS PERMISSIVE
FOR INSERT
TO public
WITH CHECK (
  EXISTS (
    SELECT 1
    FROM public.catalogs c
    WHERE c.id = catalog_products.catalog_id
      AND c.user_id = auth.uid()
  )
  AND EXISTS (
    SELECT 1
    FROM public.products p
    WHERE p.id = catalog_products.product_id
      AND p.user_id = auth.uid()
  )
);

-- SELECT: permitido si sos dueño del catálogo o del producto,
-- o si el catálogo es público Y el producto es visible
DROP POLICY IF EXISTS catprod_select_public_or_owner ON public.catalog_products;
CREATE POLICY catprod_select_public_or_owner
ON public.catalog_products
AS PERMISSIVE
FOR SELECT
TO public
USING (
  EXISTS (
    SELECT 1
    FROM public.catalogs c
    WHERE c.id = catalog_products.catalog_id
      AND c.user_id = auth.uid()
  )
  OR EXISTS (
    SELECT 1
    FROM public.products p
    WHERE p.id = catalog_products.product_id
      AND p.user_id = auth.uid()
  )
  OR (
    EXISTS (
      SELECT 1
      FROM public.catalogs c
      WHERE c.id = catalog_products.catalog_id
        AND c.is_public = true
    )
    AND EXISTS (
      SELECT 1
      FROM public.products p
      WHERE p.id = catalog_products.product_id
        AND p.visible = true
    )
  )
);
